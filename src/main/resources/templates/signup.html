<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>FlashBid - 회원가입</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #121212; color: white; }
        .input-focus:focus { border-color: #007AFF; box-shadow: 0 0 10px rgba(0, 122, 255, 0.2); }
        .error-message { color: #FF4D4D; }
        .success-message { color: #4CAF50; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">
<div class="max-w-lg w-full p-10 bg-[#1E1E1E] rounded-3xl shadow-2xl border border-gray-800">
    <div class="mb-8">
        <h1 class="text-3xl font-black text-white">시작하기</h1>
        <p class="text-gray-400 mt-2">FlashBid에서 당신만의 낙찰 스토리를 만드세요.</p>
    </div>

    <form id="signupForm" class="space-y-6">
        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase ml-1 mb-2">활동 닉네임</label>
            <div class="flex gap-2">
                <input type="text" id="nickname" name="nickname" required
                       class="flex-1 bg-[#2A2A2A] border border-gray-700 rounded-xl p-4 text-white input-focus outline-none transition-all"
                       placeholder="경매장에서 사용될 이름">
                <button type="button" id="checkNicknameBtn"
                        class="bg-[#333] text-white px-4 rounded-xl font-semibold hover:bg-[#444] transition-colors whitespace-nowrap">
                    중복확인
                </button>
            </div>
            <p id="nicknameMessage" class="text-[10px] mt-2 ml-1"></p>
            <p class="text-[10px] text-gray-500 mt-1 ml-1">* 리더보드와 커뮤니티에서 이 이름으로 활동하게 됩니다.</p>
        </div>

        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase ml-1 mb-2">아이디</label>
            <div class="flex gap-2">
                <input type="text" id="userId" name="userId" required
                       class="flex-1 bg-[#2A2A2A] border border-gray-700 rounded-xl p-4 text-white input-focus outline-none transition-all"
                       placeholder="example@bid.com">
                <button type="button" id="checkUserIdBtn"
                        class="bg-[#333] text-white px-4 rounded-xl font-semibold hover:bg-[#444] transition-colors whitespace-nowrap">
                    중복확인
                </button>
            </div>
            <p id="userIdMessage" class="text-[10px] mt-2 ml-1"></p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase ml-1 mb-2">비밀번호</label>
                <input type="password" id="password" name="password" required
                       class="w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-4 text-white input-focus outline-none transition-all"
                       placeholder="8자 이상">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase ml-1 mb-2">비밀번호 확인</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required
                       class="w-full bg-[#2A2A2A] border border-gray-700 rounded-xl p-4 text-white input-focus outline-none transition-all"
                       placeholder="한번 더 입력">
            </div>
        </div>

        <div class="p-4 bg-[#252525] rounded-xl border border-gray-800">
            <label class="flex items-start text-sm text-gray-400 cursor-pointer">
                <input type="checkbox" id="agreeTerms" class="mt-1 mr-3 accent-[#007AFF]" required>
                <span>서비스 이용약관 및 개인정보 처리방침에 동의하며, 실시간 경매 참여 규칙을 숙지하였습니다.</span>
            </label>
        </div>

        <p id="submitError" class="text-sm error-message hidden"></p>

        <button type="submit"
                class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-600 transition-colors shadow-lg shadow-blue-900/20">
            계정 생성하기
        </button>
    </form>

    <div class="mt-8 text-center text-gray-400 text-sm">
        이미 회원이신가요?
        <a th:href="@{/login}" class="text-[#FF4D00] font-bold ml-1 hover:underline">로그인</a>
    </div>
</div>

<script>
    let isUserIdChecked = false;
    let isNicknameChecked = false;
    let checkedUserId = '';
    let checkedNickname = '';

    const nicknameInput = document.getElementById('nickname');
    const userIdInput = document.getElementById('userId');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const nicknameMessage = document.getElementById('nicknameMessage');
    const userIdMessage = document.getElementById('userIdMessage');
    const submitError = document.getElementById('submitError');
    const signupForm = document.getElementById('signupForm');

    nicknameInput.addEventListener('input', function() {
        if (this.value !== checkedNickname) {
            isNicknameChecked = false;
            nicknameMessage.textContent = '';
            nicknameMessage.className = 'text-[10px] mt-2 ml-1';
        }
    });

    userIdInput.addEventListener('input', function() {
        if (this.value !== checkedUserId) {
            isUserIdChecked = false;
            userIdMessage.textContent = '';
            userIdMessage.className = 'text-[10px] mt-2 ml-1';
        }
    });

    document.getElementById('checkNicknameBtn').addEventListener('click', async function() {
        const nickname = nicknameInput.value.trim();
        if (!nickname) {
            nicknameMessage.textContent = '닉네임을 입력해주세요.';
            nicknameMessage.className = 'text-[10px] mt-2 ml-1 error-message';
            return;
        }

        try {
            const response = await fetch('/api/auth/check-nickname', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: nickname })
            });
            const data = await response.json();

            if (data.available) {
                isNicknameChecked = true;
                checkedNickname = nickname;
                nicknameMessage.textContent = data.message;
                nicknameMessage.className = 'text-[10px] mt-2 ml-1 success-message';
            } else {
                isNicknameChecked = false;
                nicknameMessage.textContent = data.message;
                nicknameMessage.className = 'text-[10px] mt-2 ml-1 error-message';
            }
        } catch (error) {
            nicknameMessage.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
            nicknameMessage.className = 'text-[10px] mt-2 ml-1 error-message';
        }
    });

    document.getElementById('checkUserIdBtn').addEventListener('click', async function() {
        const userId = userIdInput.value.trim();
        if (!userId) {
            userIdMessage.textContent = '아이디를 입력해주세요.';
            userIdMessage.className = 'text-[10px] mt-2 ml-1 error-message';
            return;
        }

        try {
            const response = await fetch('/api/auth/check-userid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId })
            });
            const data = await response.json();

            if (data.available) {
                isUserIdChecked = true;
                checkedUserId = userId;
                userIdMessage.textContent = data.message;
                userIdMessage.className = 'text-[10px] mt-2 ml-1 success-message';
            } else {
                isUserIdChecked = false;
                userIdMessage.textContent = data.message;
                userIdMessage.className = 'text-[10px] mt-2 ml-1 error-message';
            }
        } catch (error) {
            userIdMessage.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
            userIdMessage.className = 'text-[10px] mt-2 ml-1 error-message';
        }
    });

    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        submitError.classList.add('hidden');

        const nickname = nicknameInput.value.trim();
        const userId = userIdInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!isNicknameChecked || nickname !== checkedNickname) {
            submitError.textContent = '닉네임 중복확인을 해주세요.';
            submitError.classList.remove('hidden');
            return;
        }

        if (!isUserIdChecked || userId !== checkedUserId) {
            submitError.textContent = '아이디 중복확인을 해주세요.';
            submitError.classList.remove('hidden');
            return;
        }

        if (password !== confirmPassword) {
            submitError.textContent = '비밀번호가 일치하지 않습니다.';
            submitError.classList.remove('hidden');
            return;
        }

        if (password.length < 8) {
            submitError.textContent = '비밀번호는 8자 이상 입력해주세요.';
            submitError.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nickname: nickname,
                    userId: userId,
                    password: password,
                    confirmPassword: confirmPassword
                })
            });
            const data = await response.json();

            if (data.success) {
                window.location.href = data.redirectUrl;
            } else {
                submitError.textContent = data.message;
                submitError.classList.remove('hidden');
            }
        } catch (error) {
            submitError.textContent = '회원가입 중 오류가 발생했습니다. 다시 시도해주세요.';
            submitError.classList.remove('hidden');
        }
    });
</script>
</body>
</html>
